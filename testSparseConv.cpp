#include "sparseConv.h"
#include <stdio.h>

int main(){
	printf("enter Main\n");
	hls::stream<int8_channel> FM_in_stream;
	hls::stream<int8_channel> FM_out_stream;
	hls::stream<int8_channel> weight_stream;
	hls::stream<int8_channel> bias_stream;

	//Image on header
	int8 img[731] = {0, 0, 1, 63, 32, 70, 24, 89, 5, 4, 68, 0, 34, 34, 57, 80, 85, 6, 0, 12, 94, 21, 16, 20, 0, 68, 90, 46, 64, 49, 64, 89, 2, 75, 40, 47, 6, 1, 2, 2, 13, 9, 25, 39, 24, 11, 81, 18, 9, 84, 32, 75, 0, 9, 22, 95, 32, 10, 5, 56, 6, 16, 80, 0, 0, 4, 28, 0, 0, 0, 40, 86, 22, 0, 0, 0, 64, 36, 0, 64, 67, 17, 98, 12, 68, 50, 80, 18, 99, 32, 0, 0, 24, 74, 48, 12, 32, 52, 36, 28, 100, 16, 16, 8, 60, 8, 23, 0, 0, 80, 52, 10, 64, 48, 0, 64, 56, 5, 47, 84, 1, 28, 4, 43, 0, 0, 64, 2, 24, 47, 13, 33, 98, 47, 32, 21, 32, 86, 0, 16, 83, 0, 72, 60, 74, 64, 49, 1, 5, 8, 68, 0, 0, 64, 99, 34, 71, 28, 0, 0, 9, 59, 18, 0, 8, 61, 0, 0, 16, 36, 80, 31, 22, 0, 4, 66, 8, 100, 8, 4, 8, 1, 2, 45, 5, 68, 39, 0, 2, 7, 2, 83, 5, 88, 65, 32, 33, 5, 57, 50, 0, 6, 56, 13, 2, 62, 10, 51, 78, 18, 59, 43, 0, 2, 16, 0, 0, 0, 0, 3, 31, 5, 16, 34, 0, 0, 0, 0, 10, 64, 9, 0, 0, 96, 29, 45, 0, 0, 10, 44, 10, 4, 36, 0, 0, 8, 8, 0, 12, 95, 40, 0, 2, 99, 80, 25, 61, 10, 28, 80, 32, 31, 5, 45, 57, 0, 4, 40, 64, 5, 0, 0, 16, 92, 12, 22, 88, 24, 92, 59, 1, 65, 2, 75, 40, 7, 29, 32, 4, 0, 4, 18, 0, 16, 27, 0, 2, 32, 4, 37, 0, 0, 12, 78, 11, 0, 2, 23, 6, 20, 6, 0, 64, 97, 36, 77, 47, 0, 72, 14, 55, 0, 0, 4, 61, 1, 1, 9, 9, 13, 5, 4, 17, 2, 26, 2, 41, 32, 48, 0, 2, 84, 0, 0, 2, 39, 17, 83, 5, 68, 82, 27, 72, 71, 9, 3, 37, 56, 0, 32, 87, 34, 62, 15, 32, 43, 8, 55, 0, 72, 78, 68, 0, 0, 72, 21, 92, 0, 4, 35, 68, 15, 36, 66, 23, 4, 0, 0, 4, 61, 1, 3, 40, 7, 54, 0, 0, 0, 64, 11, 66, 7, 14, 32, 75, 64, 2, 0, 4, 55, 0, 2, 16, 96, 46, 57, 72, 99, 59, 18, 12, 44, 64, 27, 0, 0, 4, 19, 3, 8, 85, 2, 59, 18, 7, 35, 1, 74, 24, 68, 72, 32, 99, 0, 0, 32, 48, 65, 48, 58, 80, 93, 6, 1, 78, 48, 6, 7, 16, 72, 32, 11, 10, 13, 52, 1, 85, 64, 87, 0, 1, 93, 9, 73, 47, 0, 32, 15, 64, 39, 8, 55, 0, 1, 19, 1, 23, 8, 42, 0, 9, 69, 94, 1, 67, 80, 72, 32, 6, 45, 99, 64, 5, 0, 96, 56, 41, 4, 17, 1, 53, 17, 67, 81, 12, 89, 95, 0, 64, 95, 16, 26, 0, 6, 87, 99, 0, 0, 2, 91, 36, 79, 56, 9, 51, 21, 0, 32, 36, 16, 17, 66, 71, 75, 0, 17, 33, 24, 4, 3, 36, 8, 10, 8, 66, 64, 87, 0, 0, 16, 86, 2, 32, 64, 90, 17, 31, 89, 0, 16, 61, 8, 57, 0, 8, 20, 10, 36, 90, 0, 0, 0, 3, 58, 58, 40, 61, 89, 0, 0, 0, 0, 32, 28, 0, 0, 0, 0, 0, 0, 9, 37, 69, 12, 86, 8, 64, 61, 16, 50, 0, 0, 0, 4, 19, 0, 0, 0, 0, 0, 0, 4, 16, 0, 8, 12, 0, 8, 63, 64, 70, 0, 9, 47, 36, 0, 8, 20, 0, 80, 3, 35, 96, 78, 10, 0, 1, 79, 72, 87, 50, 0, 0, 36, 58, 96, 0, 32, 57, 0, 32, 32, 72, 60, 90, 0, 0, 6, 63, 28, 17, 31, 31, 0, 48, 10, 71, 0, 8, 94, 1, 69, 16, 26, 4, 70, 64, 55, 4, 20, 5, 54, 56, 0, 24, 98, 48, 64, 21, 0, 17, 59, 33, 2, 85, 0, 0, 32, 71, 0, 40, 6, 88, 64, 100, 0, 0, 80, 45, 74, 0, 48, 48, 53, 2, 37, 6, 48, 34, 2, 6};
	int8 wt[7*3*3*3] = {3, 11, 14, 14, 16, 16, 13, 3, 9, 13, 14, 18, 31, 18, 3, 5, 6, 21, 1, 24, 6, 3, 16, 5, 28, 1, 30, 2, 3, 4, 13, 16, 6, 29, 11, 3, 9, 3, 13, 4, 28, 5, 3, 24, 18, 25, 11, 28, 3, 3, 5, 14, 28, 16, 30, 19, 3, 23, 9, 24, 14, 29, 9, 3, 19, 7, 29, 10, 31, 17, 3, 11, 15, 21, 2, 25, 10, 3, 20, 3, 28, 5, 30, 12, 3, 13, 12, 15, 8, 20, 6, 3, 24, 19, 30, 18, 31, 17, 3, 17, 13, 27, 17, 30, 5, 3, 22, 6, 24, 16, 25, 6, 3, 18, 3, 25, 16, 29, 6, 3, 4, 20, 5, 19, 30, 19, 3, 20, 3, 21, 7, 25, 5, 3, 16, 18, 22, 13, 30, 19, 3, 23, 15, 24, 3, 27, 2, 3, 6, 3, 28, 20, 31, 2, 3, 1, 2, 7, 9, 15, 10, 3, 7, 6, 29, 12, 30, 15, 3, 9, 17, 22, 17, 28, 9, 3, 14, 1, 18, 8, 31, 2, 3, 0, 2, 3, 18, 29, 9};
	int8 bias[32] = {1,-1,-1,0,1,1,1,0,0,0,0,1,0,0,0,0,0,-1,-1,1,0,-1,1,-1,1,0,1,1,1,-1,0,0};
	int8_channel valIn;
	valIn.keep = 1; valIn.strb = 1; valIn.user = 1; valIn.id = 0; valIn.dest = 0;
	valIn.data = 0;

	printf("init FM...");
	for (int idx=0; idx < 731; idx++) {
		valIn.data = img[idx];
		FM_in_stream << valIn;
	}
	printf("OK\n");
	printf("init weight...");
	for (int i = 0; i < 27 * 7; i++) {
		valIn.data = wt[i];
		weight_stream << valIn;
	}

	printf("OK\n");
	printf("init bias...");
	for (int i = 0; i < 32; i++) {
		valIn.data = bias[i];
		bias_stream << valIn;
	}
	printf("OK\n");
	printf("proceeding conv...");
	sparseConv(FM_in_stream, FM_out_stream, weight_stream, bias_stream);
	printf("OK\n");
	while(!FM_out_stream.empty()) {
		printf("%d, ", FM_out_stream.read().data);
	}
//	for(int idx = 0; idx < 32*32*32; idx++) {
//		int8 val = FM_out_stream.read().data;
//		if(val != out[idx]){
//			printf("%d, %d, %d   ", idx, val, out[idx]);
//		}
//	}

	printf("succeed!\n\n");


	return 0;
}
